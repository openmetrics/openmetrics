<script type="text/javascript" data-turbolinks-eval=false>

    $(".systems.show").ready(function() {
        console.log("Systems Show JS Ready");

        // set timeline http://visjs.org/docs/timeline.html
        // DOM element where the Timeline will be attached
        var container = document.getElementById('timeline');

        // Create a DataSet (allows two way data-binding)
//        var items = new vis.DataSet([
//            {id: 1, content: 'item 1', start: '2014-04-20'},
//            {id: 2, content: 'item 2', start: '2014-04-14'},
//            {id: 3, content: 'item 3', start: '2014-04-18'},
//            {id: 4, content: 'item 4', start: '2014-04-16', end: '2014-04-19'},
//            {id: 5, content: 'item 5', start: '2014-04-25'},
//            {id: 6, content: 'item 6', start: '2014-04-27', type: 'point'}
//        ]);


        var items = new vis.DataSet([
            <% @system_events.each do |a| %>
                {id: <%= a.id %>, content: '<%= a.key %>', start: '<%= a.created_at.to_time.iso8601 %>', type: 'point'},
            <% end %>
        ]);

        // Configuration for the Timeline
        var options = {};

        // Create a Timeline
        if (container) {
            var timeline = new vis.Timeline(container, items, options);
        }





        // system network graph (currently system and it's running services)
        var nodes = new vis.DataSet([
            {id: <%= @system.id %>, label: '<%= @system.name %>', group: 'system'},
            <% @system.running_services.each do |rs| %>
                {id: <%= rs.id %>, label: '<%= rs.service.name %>', group: 'running_service'},
            <% end %>
        ]);


        // create an array with edges
        var edges = [
            // connect running services with system
            <% @system.running_services.each do |rs| %>
                {from: <%= @system.id %>, to: <%= rs.id %>, style: 'dash-line'},
            <% end %>
        ];

        // create a network
        var container = document.getElementById('system-graph');
        var data = {
            nodes: nodes,
            edges: edges
        };
        var options = {
            height: '450px',
            navigation: true,
            keyboard: false,
            groups: {
                system: {
                    shape: 'box',
                    color: {
                        background: "#428bca"
                    },
                    fontColor: 'white',
                    fontSize: 12
                },
                running_service: {
                    shape: 'dot',
                    color: {
                        color: 'white',
                        border: "#428bca"
                    },
                    fontSize: 10

                }
            }
        };
        if (container) {
            var network = new vis.Network(container, data, options);
        }

//    $.ajax({
//        url: '/systems/<%= @system.id %>',
//        type: "GET",
//        complete: function(data,stat){
//            if(stat=="success") {
//                ResponseData = JSON.parse(data.responseText);
//                var widgets = ResponseData.widgets;
//                renderWidget(widgets);
//            }
//        }
//    });
    });
</script>

<% content_for :page_header do %>
    <h3>
      <%= badge_label @system, {:label_class => 'primary'} %>
      <span class="btn-group btn-group-sm pull-right">
        <%= link_to t('om.controls.delete_html'), @system, :confirm => 'Are you sure?', :method => :delete, :class => 'btn btn-default' %>
        <%= link_to t('om.controls.edit_html'), edit_system_path(@system), :class => 'btn btn-default' %>
      </span>
    </h3>
<% end %>

<div class="row">

  <!-- left column -->
  <div class="col-md-8">

    <!-- metrics tabs left -->
    <% if @system_metrics.any? %>
        <h3>Metrics</h3>
        <div class="panel panel-default">
          <div class="panel-body">
            <div class="tabbable">
              <ul class="nav nav-tabs">
                <% @system_metrics.each_with_index do |plugin, index| %>
                    <li <%= 'class=active' if index == 0 %> >
                      <a href="#<%= plugin.first %>" data-toggle="tab"><%= plugin.first %></a>
                    </li>
                <% end %>
              </ul>
              <div class="tab-content">
                <% @system_metrics.each_with_index do |plugin, index| %>
                    <div class="tab-pane <%= 'active' if index == 0 %>" id="<%= plugin.first %>">
                      <% rrds = @system_metrics[plugin.first].group_by(&:rrd_file) %>
                      <% rrds.each_pair do |rrd, x| %>
                          <h4><%= rrd %></h4>
                          <% img_path = "/collectd/#{@system.fqdn}.dir/#{@system.fqdn}/#{x.first.plugin}/#{x.first.rrd_file}-1day.png" %>
                          <img src="<%= img_path %>"/>
                      <% end %>

                    </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
    <% end %>
    <!-- /tabs -->

    <div class="clearfix"></div>


    <!-- timeline (will be filled by js) -->
    <h3 class="spacer">Events</h3>
    <div class="panel panel-default">
      <div class="panel-body">
        <%= render 'shared/activities', events: @system_events %>
        <h4>Timeline</h4>
        <div id="timeline"></div>
      </div>
    </div>

    <!-- system graph (will be filled by js) -->
    <h3 class="spacer">Relation Graph</h3>

    <div class="clearfix"></div>
    <div class="panel panel-default ">
      <div class="panel-body">
        <div id="system-graph"></div>
      </div>
    </div>

  </div>


  <!-- right column -->
  <div class="col-md-4">
    <%= render :partial => 'system_information' %>
    <h3 class="spacer">Running Services</h3>
    <div class="list-group running_service">
      <%= render :partial => 'running_services', :collection => @system.running_services, :as => :rs %>
    </div>

  </div>
</div>